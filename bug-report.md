# Bug Report: "There was a problem with the session" — React Hydration Crash in Claude Desktop App

> **GitHub Issue:** https://github.com/anthropics/claude-code/issues/27345
> **Date Investigated:** 2026-02-21
> **Severity:** High — conversations become permanently unrecoverable through the UI
> **Reproducibility:** Consistent with large sessions generated by high-parallelism skills

---

## Summary

The Claude desktop app (Electron, v1.1.3918) repeatedly crashes with "There was a problem with the session" when loading conversations that:

1. Were generated by multi-agent skills (e.g., `pr-code-review`) that produce large volumes of parallel output
2. Contain XML-like wrapper tags injected by the skill invocation protocol (`<command-message>`, `<ide_opened_file>`, etc.)

The root cause is a **React hydration mismatch (error #418)** in the Electron renderer — the SSR-rendered HTML text nodes diverge from what React's client-side hydration expects when the content contains raw angle-bracket characters. A secondary infinite re-render loop (error #185) compounds the crash when multiple parallel agent outputs resolve simultaneously.

**The IDE extension is unaffected** because it renders conversations through a plain webview without the SSR+hydration pipeline.

---

## Environment

| Field | Value |
|-------|-------|
| **OS** | macOS 26.3 (Build 25D125) |
| **Claude Desktop App Version** | 1.1.3918 |
| **Claude Code CLI** | Installed (via `~/.claude/`) |
| **Python** | 3.12.1 |
| **MCP Servers** | `MCP_DOCKER` (docker mcp gateway) |
| **Plugin** | `visionary-studios@vs-claude-marketplace` v1.0.0-beta.1 |

---

## Symptoms

- Opening a specific conversation in the desktop app shows: **"There was a problem with the session"**
- The conversation is completely unloadable — no content visible, no scroll, no retry
- Error occurs immediately on conversation open, before any input
- Restarting the desktop app does not resolve it
- The same conversation ID opens and works correctly in the VS Code IDE extension
- Error has occurred **6+ times over two days**, consistently on sessions that used the `pr-code-review` skill

---

## Error Log Evidence

From `~/Library/Logs/Claude/claude.ai-web.log`:

### Error 1: React #418 — Hydration Mismatch (primary crash)

```
2026-02-20 17:58:19 [error] Uncaught Error: Minified React error #418;  args[]=text&args[]=
2026-02-21 00:16:13 [error] Uncaught Error: Minified React error #418;  args[]=HTML&args[]=
2026-02-21 00:19:11 [error] Uncaught Error: Minified React error #418;  args[]=HTML&args[]=
2026-02-21 00:20:30 [error] Uncaught Error: Minified React error #418;  args[]=HTML&args[]=
2026-02-21 00:23:46 [error] Uncaught Error: Minified React error #418;  args[]=HTML&args[]=
```

React error #418 = "Text content does not match server-rendered HTML" — see https://react.dev/errors/418

### Error 2: React #185 — Maximum Update Depth (secondary, during active sessions)

```
2026-02-21 00:13:47 [error] Error: Minified React error #185
2026-02-21 00:13:53 [error] Error: Minified React error #185
2026-02-21 00:13:59 [error] Error: Minified React error #185
2026-02-21 00:14:01 [error] Error: Minified React error #185
2026-02-21 00:14:04 [error] Error: Minified React error #185
2026-02-21 00:14:09 [error] Error: Minified React error #185
```

React error #185 = "Maximum update depth exceeded" — see https://react.dev/errors/185

### Error 3: EventEmitter Memory Leak (cumulative across sessions)

```
2026-02-20 17:58:19 [warn] MaxListenersExceededWarning: Possible EventEmitter memory leak detected.
  11 $eipc_message$_a97164db-..._$_AutoUpdater_$_updaterState_$store$_update listeners added.
  Use emitter.setMaxListeners() to increase limit
```

This warning repeats across **every session restart**, accumulating to 11 listeners on the same IPC channel. Node.js warns at 10 (the default `EventEmitter.defaultMaxListeners`).

---

## Root Cause Analysis

### Cause 1: XML Tags in User Message Content → React #418

Claude's skill invocation protocol wraps skill calls in XML-like tags embedded directly in the `user` message content:

```
<command-message>visionary-studios:pr-code-review</command-message>
<command-name>/visionary-studios:pr-code-review</command-name>
<command-args>
https://github.com/markwoitaszek/gpu-photo-pipeline/pull/203
</command-args>
```

And system events inject similar tags:

```
<ide_opened_file>The user opened the file /path/to/file.ext in the IDE...</ide_opened_file>
```

When the Electron desktop app renders these conversations, it performs **SSR (server-side rendering in the main process)** and then **hydrates** the result in the renderer process. The angle-bracket characters in these tags cause React to produce different DOM text node content at SSR time vs. hydration time, resulting in error #418.

The `args[]=HTML` variant (vs. `args[]=text`) suggests React is attempting to parse these tags as HTML rather than escaping them as text — the serialization path differs between the two render passes.

### Cause 2: Simultaneous Multi-Agent State Flushes → React #185

The `pr-code-review` skill launches **8 parallel audit agents** simultaneously. When all 8 resolve within a short window and push their results to the conversation state, React receives rapid-fire `setState` calls that exceed its batching budget, triggering a render cycle deeper than the call stack allows.

Evidence: the React #185 errors appear in tight clusters (6 errors in 22 seconds: `00:13:47 → 00:14:09`) immediately after large sessions complete.

### Cause 3: IPC Listener Accumulation → Memory Leak

The `AutoUpdater` IPC channel accumulates listeners with each new session window/connection without removing them. By the time the 11th listener is added, Node.js emits `MaxListenersExceededWarning`. This suggests session teardown is not calling `.removeListener()` / `.off()` on the IPC event emitter.

While not the direct cause of the crash, this memory leak increases overall renderer instability.

---

## Session File Evidence

Affected session files from `~/.claude/projects/-Users-…-gpu-photo-pipeline/`:

| Session ID | Date | Size | Trigger |
|------------|------|------|---------|
| `ef714850` | 2026-02-21 00:24 | **4.5 MB** | `pr-code-review` PR #203 — crashed loading |
| `c51c28ff` | 2026-02-21 00:14 | **2.7 MB** | `pr-code-review` PR #203 — crashed loading |
| `2ce34ca7` | 2026-02-20 23:23 | **8.4 MB** | `test-audit` PR #201 |
| `26aded10` | 2026-02-20 18:26 | **15.4 MB** | Enterprise branch audit — first crash at 17:58 |

The 15.4 MB session produced the first React #418 at `17:58:19`, establishing the size threshold at which the hydration pipeline fails.

Manual inspection of `ef714850.jsonl` found **395 HTML-like patterns** (`<tag>` sequences) embedded in message content, confirming the XML tag injection vector.

---

## Impact

- **Conversations are permanently lost** through the desktop app UI — there is no retry, scroll, or fallback rendering mode
- **No warning is shown** before the crash — conversations appear in the sidebar and look normal, but immediately error on open
- **Repeated occurrence** — any project that uses high-parallelism skills (`pr-code-review`, `test-audit`, `idea-deep-dive`) will hit this within 2–3 sessions on a large codebase
- **Desktop-only** — the VS Code IDE extension is completely unaffected

---

## Reproduction Steps

1. Install a skill that launches multiple parallel agents (e.g., `visionary-studios:pr-code-review`)
2. Run the skill against a large PR (50+ changed files)
3. Allow 2–3 full runs to accumulate (each session will be 1–5 MB)
4. Open the desktop app and click any of those sessions in the sidebar
5. Observe: "There was a problem with the session" — conversation is blank and unloadable

**Fastest repro:** Load session `ef714850-2528-4e07-8b18-a40df9fcee1e` from a backup if accessible to Anthropic engineers.

---

## Workarounds

### For end users (right now)

Use the [claude-session-recovery](https://github.com/markwoitaszek/claude-session-recovery) utility to extract conversations directly from the JSONL files:

```bash
git clone https://github.com/markwoitaszek/claude-session-recovery.git
python3 session_recovery.py --project myproject --last 2
```

### To avoid future crashes

- Use the **VS Code IDE extension** for skills that generate large parallel output
- Avoid running `pr-code-review` / `test-audit` / `idea-deep-dive` from the desktop app on PRs with >50 changed files

---

## Suggested Fixes

### Fix 1: Escape angle-bracket content at the SSR serialization layer (addresses #418)

Before SSR-serializing `user` message content, ensure text nodes containing `<` and `>` characters are HTML-escaped so both render passes produce identical DOM output:

```js
// In the message content serializer, escape before passing to React:
const safeText = rawText
  .replace(/&/g, '&amp;')
  .replace(/</g, '&lt;')
  .replace(/>/g, '&gt;');
```

The key invariant: text nodes that contain angle-bracket characters must be treated as **plain text** in both the SSR pass and the hydration pass, not as HTML markup.

### Fix 2: Batch multi-agent state updates (addresses #185)

Wrap the state flush from concurrent agent completions in React's batched update mechanism to prevent the update depth from exceeding React's limit:

```js
// React 18+ automatic batching applies to async operations,
// but explicitly flushing inside flushSync or startTransition
// ensures bounded render depth for large bursts:
import { startTransition } from 'react';

startTransition(() => {
  agentResults.forEach(result => dispatch(appendMessage(result)));
});
```

### Fix 3: Clean up IPC listeners on session teardown (addresses memory leak)

In the session teardown lifecycle, explicitly remove all listeners registered during the session rather than relying on garbage collection:

```js
// Track listeners at registration time
const listeners = new Map();

function addSessionListener(channel, handler) {
  ipcRenderer.on(channel, handler);
  listeners.set(channel, handler);
}

// On session teardown:
function cleanup() {
  for (const [channel, handler] of listeners) {
    ipcRenderer.removeListener(channel, handler);
  }
  listeners.clear();
}
```

### Fix 4: Graceful degradation for large or corrupted sessions

If a conversation fails to hydrate, fall back to a **plain-text or simplified rendering mode** rather than showing a blank error screen. The raw JSONL data is always intact on disk — a text-only fallback would allow users to read their conversations even when the rich renderer fails.

---

## Related

- [React error #418 reference](https://react.dev/errors/418)
- [React error #185 reference](https://react.dev/errors/185)
- [claude-session-recovery](https://github.com/markwoitaszek/claude-session-recovery) — recovery utility built as a result of this bug
