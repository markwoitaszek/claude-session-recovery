# Claude Session Recovery Utility

A zero-dependency Python utility that **locates, selects, extracts, and parses** Claude Code session JSONL files into clean Markdown â€” designed for recovering conversations from sessions that crash or become unloadable in the Claude desktop app.

> **Why this exists:** The Claude desktop app (Electron) renders conversations using a React hydration pipeline. Large sessions â€” especially those generated by high-parallelism skills like `pr-code-review` â€” can contain XML-like content (`<command-message>`, `<ide_opened_file>`) that triggers React hydration mismatches (error #418), causing the "There was a problem with the session" error and making the conversation irrecoverable through the UI. See [bug-report.md](./bug-report.md) for the full investigation.

---

## Requirements

- Python 3.10+ (uses `list[dict]` type hints)
- No third-party packages â€” stdlib only

---

## Installation

```bash
# Clone or copy the script
git clone https://github.com/markwoitaszek/claude-session-recovery.git
cd claude-session-recovery

# Make it executable (optional)
chmod +x session_recovery.py

# Or install the alias for convenience
echo 'alias session-recovery="python3 /path/to/session_recovery.py"' >> ~/.zshrc
```

---

## Usage

### Interactive Mode (recommended â€” shows the full hierarchy)

```bash
python3 session_recovery.py
```

Displays the complete **project â†’ spec â†’ session hierarchy** in a tree view, then lets you pick sessions directly by number:

```
Claude Code  Â·  Project & Session Hierarchy
  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  ğŸ“ ~/VSCodeRepos/markwoitaszek/gpu-photo-pipeline
     â”‚  spec: GPU photo pipeline with CUDA acceleration and parallel processing
     â”‚  5 session(s)  Â·  31.1 MB total  Â·  last active 2026-02-21 00:24
     â”‚
     â”œâ”€ Today
     â”‚    â”œâ”€ [ 1] ef714850  2026-02-21 00:24    4.5 MB  âš  CRASH RISK
     â”‚    â”‚        /visionary-studios:pr-code-review PR #203
     â”‚    â””â”€ [ 2] c51c28ff  2026-02-21 00:14    2.7 MB  âš  CRASH RISK
     â”‚             /visionary-studios:pr-code-review PR #203
     â”œâ”€ Yesterday
     â”‚    â”œâ”€ [ 3] 2ce34ca7  2026-02-20 23:23    8.4 MB  âš  CRASH RISK
     â”‚    â”‚        /visionary-studios:test-audit PR #201
     â”‚    â””â”€ [ 4] 26aded10  2026-02-20 18:26   15.4 MB  âš  CRASH RISK
     â”‚             enterprise branch audit â€” full codebase scan
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Select sessions to recover:
  Enter numbers 1â€“4, comma-separated (1,3), ranges (2-5), or 'a' for all

  â†’
```

- **âš  CRASH RISK** â€” session is likely unloadable in the desktop app (large + XML skill tags detected)
- **â—ˆ LARGE** â€” session is large but may still render
- Select by **number**, **range** (`2-4`), **comma list** (`1,3`), or **`a`** for all

### `--tree` â€” Hierarchy view only (no export)

```bash
python3 session_recovery.py --tree
python3 session_recovery.py --tree --project gpu
```

Displays the full hierarchy and exits â€” useful for a quick overview of all projects and their sessions.

### CLI Flags

```bash
# Show full project/session hierarchy (read-only)
python3 session_recovery.py --tree

# Filter projects and recover last N sessions
python3 session_recovery.py --project gpu --last 2

# Recover a specific session by ID prefix
python3 session_recovery.py --session ef714850

# List all projects (compact, no session detail)
python3 session_recovery.py --all-projects

# List all projects AND their sessions (compact)
python3 session_recovery.py --list

# Include tool call/result details in the output
python3 session_recovery.py --project gpu --last 2 --include-tools

# Custom output directory
python3 session_recovery.py --project gpu --last 3 --output ~/Desktop/recovered

# Strip timestamps from output
python3 session_recovery.py --session ef714850 --no-timestamps
```

| Flag | Short | Description |
|------|-------|-------------|
| `--tree` | `-T` | Display full project/specification/session hierarchy |
| `--project TEXT` | `-p` | Filter projects by name substring |
| `--list` | `-l` | List all projects and their sessions (compact) |
| `--all-projects` | `-A` | List all projects (no session detail) |
| `--session ID` | `-s` | Extract one session by ID (prefix match) |
| `--last N` | `-n` | Extract last N sessions from matched project |
| `--output DIR` | `-o` | Output directory (default: `~/.claude/session-exports/`) |
| `--include-tools` | `-t` | Expand tool calls and results in output |
| `--no-timestamps` | | Omit per-message timestamps |

---

## How Claude Session Files Work

`â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`

Claude Code stores each conversation as a **newline-delimited JSON** (JSONL) file in:

```
~/.claude/projects/<workspace-slug>/<session-uuid>.jsonl
```

Where `<workspace-slug>` is the absolute workspace path with every `/` replaced by `-`:

```
/Users/you/repos/my-project  â†’  -Users-you-repos-my-project
```

Project specifications (memory / context) live in:

```
<workspace>/CLAUDE.md         # project-level spec â€” shown in the hierarchy tree
<workspace>/CLAUDE.local.md   # local overrides (not committed)
~/.claude/CLAUDE.md           # global spec
```

Each line in a session JSONL is a typed event record:

| `type` | Contents |
|--------|----------|
| `queue-operation` | Session lifecycle events (enqueue/dequeue) |
| `file-history-snapshot` | File state snapshots for undo |
| `user` | A user message with `message.content[]` blocks |
| `assistant` | An assistant response with `message.content[]` blocks |
| `tool_result` | Raw tool output (can be very large) |

Content blocks within `user` and `assistant` records use the Anthropic content block format:
- `{ "type": "text", "text": "..." }` â€” the actual message text
- `{ "type": "tool_use", "name": "...", "input": {...} }` â€” a tool invocation
- `{ "type": "tool_result", "content": [...] }` â€” tool output

`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`

---

## Output Format

Each recovered session produces a `.md` file:

```markdown
# Session: `ef714850`

| Field | Value |
|-------|-------|
| **Project** | `~/VSCodeRepos/markwoitaszek/gpu-photo-pipeline` |
| **Session ID** | `ef714850-2528-4e07-8b18-a40df9fcee1e` |
| **Date** | 2026-02-21 00:24 |
| **Size** | 1.77 MB |
| **Messages** | 41 |
| **Topic** | /visionary-studios:pr-code-review PR #203 |

---

## ğŸ’¬ User _00:20:09_

Provide a comprehensive architectural code review...

---

## ğŸ¤– Assistant _00:20:15_

Phase 1 complete â€” PR #203 is eligible. Now fetching the diff...

---
```

Files are named:
```
<project-slug-prefix>_<session-id-prefix>_<datetime>.md
```

---

## Common Recovery Scenarios

### "There was a problem with the session"

The desktop app can no longer render the session. Run the interactive mode â€” crashed sessions are automatically flagged with **âš  CRASH RISK**:

```bash
python3 session_recovery.py
# Select the flagged session numbers and press Enter
```

Or recover a specific session directly:

```bash
python3 session_recovery.py --session ef714850
```

### Browse everything first, then pick

```bash
python3 session_recovery.py --tree
# Read the tree, note the numbers you want, then:
python3 session_recovery.py
# Type: 1,3 or 2-5 or a
```

### Recovering the last 2 sessions for a project

```bash
python3 session_recovery.py --project myproject --last 2
```

### Session crashed mid-run, want full tool trace

```bash
python3 session_recovery.py --session ef714850 --include-tools
```

### Don't know which project

```bash
python3 session_recovery.py --tree
```

---

## Known Limitations

- **Path reconstruction is heuristic.** Because Claude encodes directory slugs by replacing `/` with `-`, project names with hyphens (like `gpu-photo-pipeline`) are ambiguous in the slug. The utility walks filesystem prefix splits to find a matching path, which works in most cases but may misidentify project names in the metadata header. The JSONL content is always correctly parsed regardless.
- **Tool results are truncated to 800 chars** by default to keep Markdown readable. Use `--include-tools` to expand them (output can be very large for sessions with heavy tool use).
- **Python 3.10+ required** for the `list[dict]` type hint syntax. Python 3.9 users can replace `list[dict]` with `List[Dict]` from `typing`.
- **`%-d` date formatting** (day without leading zero) is Linux/macOS only. On Windows, replace with `%d`.

---

## Related

- [bug-report.md](./bug-report.md) â€” Full investigation of the React hydration crash in the Claude desktop app (filed as [anthropics/claude-code#27345](https://github.com/anthropics/claude-code/issues/27345))
- [Claude Code documentation](https://docs.anthropic.com/claude-code)
