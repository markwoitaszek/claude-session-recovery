# Claude Session Recovery Utility

A zero-dependency Python utility that **locates, selects, extracts, and parses** Claude Code session JSONL files into clean Markdown â€” designed for recovering conversations from sessions that crash or become unloadable in the Claude desktop app.

> **Why this exists:** The Claude desktop app (Electron) renders conversations using a React hydration pipeline. Large sessions â€” especially those generated by high-parallelism skills like `pr-code-review` â€” can contain XML-like content (`<command-message>`, `<ide_opened_file>`) that triggers React hydration mismatches (error #418), causing the "There was a problem with the session" error and making the conversation irrecoverable through the UI. See [bug-report.md](./bug-report.md) for the full investigation.

---

## Requirements

- Python 3.10+ (uses `list[dict]` type hints)
- No third-party packages â€” stdlib only

---

## Installation

```bash
# Clone or copy the script
git clone https://github.com/markwoitaszek/claude-session-recovery.git
cd claude-session-recovery

# Make it executable (optional)
chmod +x session_recovery.py

# Or install the alias for convenience
echo 'alias session-recovery="python3 /path/to/session_recovery.py"' >> ~/.zshrc
```

---

## Usage

### Interactive Mode (recommended for first use)

```bash
python3 session_recovery.py
```

Walks you through:
1. **Project selection** â€” lists all Claude Code project directories with size and session count
2. **Session selection** â€” lists sessions newest-first with topic hints; flags sessions >5MB that are most likely to be corrupted
3. **Options** â€” include tool calls, timestamps, custom output directory
4. **Export** â€” writes Markdown files and reports the output paths

### CLI Flags

```bash
# Filter projects and recover last N sessions
python3 session_recovery.py --project gpu --last 2

# Recover a specific session by ID prefix
python3 session_recovery.py --session ef714850

# List all projects (no export)
python3 session_recovery.py --all-projects

# List all projects AND their sessions
python3 session_recovery.py --list

# Include tool call/result details in the output
python3 session_recovery.py --project gpu --last 2 --include-tools

# Custom output directory
python3 session_recovery.py --project gpu --last 3 --output ~/Desktop/recovered

# Strip timestamps from output
python3 session_recovery.py --session ef714850 --no-timestamps
```

| Flag | Short | Description |
|------|-------|-------------|
| `--project TEXT` | `-p` | Filter projects by name substring |
| `--list` | `-l` | List all projects and their sessions |
| `--all-projects` | `-A` | List all projects (no session detail) |
| `--session ID` | `-s` | Extract one session by ID (prefix match) |
| `--last N` | `-n` | Extract last N sessions from matched project |
| `--output DIR` | `-o` | Output directory (default: `~/.claude/session-exports/`) |
| `--include-tools` | `-t` | Expand tool calls and results in output |
| `--no-timestamps` | | Omit per-message timestamps |

---

## How Claude Session Files Work

`â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`

Claude Code stores each conversation as a **newline-delimited JSON** (JSONL) file in:

```
~/.claude/projects/<workspace-slug>/<session-uuid>.jsonl
```

Where `<workspace-slug>` is the absolute workspace path with every `/` replaced by `-`:

```
/Users/you/repos/my-project  â†’  -Users-you-repos-my-project
```

Each line in the JSONL is a typed event record:

| `type` | Contents |
|--------|----------|
| `queue-operation` | Session lifecycle events (enqueue/dequeue) |
| `file-history-snapshot` | File state snapshots for undo |
| `user` | A user message with `message.content[]` blocks |
| `assistant` | An assistant response with `message.content[]` blocks |
| `tool_result` | Raw tool output (can be very large) |

Content blocks within `user` and `assistant` records use the Anthropic content block format:
- `{ "type": "text", "text": "..." }` â€” the actual message text
- `{ "type": "tool_use", "name": "...", "input": {...} }` â€” a tool invocation
- `{ "type": "tool_result", "content": [...] }` â€” tool output

`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`

---

## Output Format

Each recovered session produces a `.md` file:

```markdown
# Session: `ef714850`

| Field | Value |
|-------|-------|
| **Project** | `~/VSCodeRepos/markwoitaszek/gpu-photo-pipeline` |
| **Session ID** | `ef714850-2528-4e07-8b18-a40df9fcee1e` |
| **Date** | 2026-02-21 00:24 |
| **Size** | 1.77 MB |
| **Messages** | 41 |
| **Topic** | /visionary-studios:pr-code-review PR #203 |

---

## ðŸ’¬ User _00:20:09_

Provide a comprehensive architectural code review...

---

## ðŸ¤– Assistant _00:20:15_

Phase 1 complete â€” PR #203 is eligible. Now fetching the diff...

---
```

Files are named:
```
<project-slug-prefix>_<session-id-prefix>_<datetime>.md
```

---

## Common Recovery Scenarios

### "There was a problem with the session"

The desktop app can no longer render the session. Run:

```bash
python3 session_recovery.py --list
# identify the affected session ID from the timestamp/size

python3 session_recovery.py --session <id-prefix>
```

### Recovering the last 2 sessions for a project

```bash
python3 session_recovery.py --project myproject --last 2
```

### Session crashed mid-run, want full tool trace

```bash
python3 session_recovery.py --session ef714850 --include-tools
```

### Don't know which project

```bash
python3 session_recovery.py --list
```
Use the interactive list (newest-first, with topic hints) to identify the right project/session.

---

## Known Limitations

- **Path reconstruction is heuristic.** Because Claude encodes directory slugs by replacing `/` with `-`, project names with hyphens (like `gpu-photo-pipeline`) are ambiguous in the slug. The utility walks filesystem prefix splits to find a matching path, which works in most cases but may misidentify project names in the metadata header. The JSONL content is always correctly parsed regardless.
- **Tool results are truncated to 800 chars** by default to keep Markdown readable. Use `--include-tools` to expand them (be warned: output can be very large for sessions with heavy tool use).
- **Python 3.10+ required** for the `list[dict]` type hint syntax. Python 3.9 users can replace `list[dict]` with `List[Dict]` from `typing`.

---

## Related

- [bug-report.md](./bug-report.md) â€” Full investigation of the React hydration crash in the Claude desktop app
- [Claude Code documentation](https://docs.anthropic.com/claude-code)
